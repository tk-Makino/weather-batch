service: weather-batch

frameworkVersion: '3'

provider:
  name: aws
  runtime: java21
  region: ap-northeast-1
  memorySize: 512
  timeout: 300
  architecture: x86_64
  
  environment:
    PDF_URLS: https://www.jma.go.jp/bosai/numericmap/data/nwpmap/fupa252_00.pdf
    S3_BUCKET_NAME: ${self:custom.bucketName}
    AWS_REGION: ${self:provider.region}
    S3_PREFIX: pdfs/
    S3_METADATA_KEY: pdfs/metadata.json
  
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:ListBucket
          Resource:
            - arn:aws:s3:::${self:custom.bucketName}
            - arn:aws:s3:::${self:custom.bucketName}/*
  
  logs:
    restApi: true

custom:
  bucketName: weather-batch-pdfs-${sls:stage}

functions:
  fetchWeather:
    handler: com.example.pdfbatch.lambda.LambdaHandler::handleRequest
    description: Fetch weather charts from JMA and store to S3
    events:
      - schedule:
          rate: cron(0 * * * ? *)
          description: Hourly PDF fetch schedule
          enabled: true
    package:
      artifact: build/distributions/weather-batch.zip

resources:
  Resources:
    WeatherBatchBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.bucketName}
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            - Id: DeleteOldVersions
              Status: Enabled
              NoncurrentVersionExpirationInDays: 30
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true

package:
  individually: true
  
plugins:
  - serverless-plugin-log-retention

# Serverless Frameworkプラグイン（オプション）
# npm install --save-dev serverless-plugin-log-retention
